<!DOCTYPE html>
<html>
<head>
    <title>MCQ Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        .hidden { display: none; }
        #timer {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .question-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 20px 0;
        }
        .question-nav button {
            width: 40px;
            height: 40px;
        }
        .nav-answered {
            background-color: #198754 !important;
            color: white !important;
        }
        .result-correct {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .result-incorrect {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <!-- Generator Section -->
        <div id="generator-section">
            <h1 class="mb-4">MCQ Generator</h1>
            <form id="url-form" class="mb-4">
                <div class="mb-3">
                    <label class="form-label">Choose Input Method:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="input_method" id="url_input" value="url" checked>
                        <label class="form-check-label" for="url_input">URL</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="input_method" id="file_input" value="file">
                        <label class="form-check-label" for="file_input">File Upload</label>
                    </div>
                </div>
                
                <div id="url-section" class="mb-3">
                    <label for="url" class="form-label">Enter URL:</label>
                    <input type="url" class="form-control" id="url" name="url">
                </div>

                <div id="file-section" class="mb-3 hidden">
                    <label for="file" class="form-label">Upload File (PDF/Word/Text):</label>
                    <input type="file" class="form-control" id="file" name="file" accept=".pdf,.doc,.docx,.txt">
                    <small class="text-muted">Supported formats: PDF, Word (doc/docx), Text files</small>
                </div>

                <div class="mb-3">
                    <label for="num_questions" class="form-label">Number of Questions:</label>
                    <input type="number" class="form-control" id="num_questions" name="num_questions" value="{{ default_questions }}" min="5" max="100">
                </div>

                <div class="mb-3">
                    <label for="difficulty" class="form-label">Difficulty Level:</label>
                    <select class="form-select" id="difficulty" name="difficulty" required>
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                        <option value="very_hard">Very Hard</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">Generate Questions</button>
            </form>
            <div id="progress" class="hidden">
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="status" class="alert alert-info"></div>
            </div>
        </div>

        <!-- Preview Section -->
        <div id="preview-section" class="hidden">
            <h2 class="mb-4">Questions Generated Successfully!</h2>
            <div class="card mb-4">
                <div class="card-body">
                    <h5>Test Information</h5>
                    <p>Total Questions: <span id="preview-total-questions"></span></p>
                    <p>Difficulty Level: <span id="preview-difficulty"></span></p>
                    <p>Estimated Time: <span id="preview-estimated-time"></span> minutes</p>
                    <div class="alert alert-info">
                        <strong>Instructions:</strong>
                        <ul class="mb-0">
                            <li>Each question has 6 options (a-f)</li>
                            <li>You can navigate between questions</li>
                            <li>Timer will start when you begin the test</li>
                            <li>You can submit the test at any time</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button id="start-test-btn" class="btn btn-success">Start Test</button>
                <button id="regenerate-btn" class="btn btn-secondary">Generate New Questions</button>
            </div>
        </div>

        <!-- Test Section -->
        <div id="test-section" class="hidden">
            <div id="timer" class="mb-3">
                Time: <span id="time-display">00:00</span>
            </div>
            <div class="question-nav mb-4"></div>
            <div id="question-display" class="mb-4">
                <h3 id="question-text"></h3>
                <div id="options" class="list-group">
                    <!-- Options will be inserted here -->
                </div>
            </div>
            <div class="d-flex justify-content-between">
                <button id="prev-question" class="btn btn-secondary">Previous</button>
                <button id="next-question" class="btn btn-primary">Next</button>
                <button id="finish-test" class="btn btn-success">Finish Test</button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <h2 class="mb-4">Test Results</h2>
            <div class="card mb-4">
                <div class="card-body">
                    <h5>Summary</h5>
                    <p>Total Questions: <span id="total-questions"></span></p>
                    <p>Difficulty Level: <span id="difficulty-level"></span></p>
                    <p>Correct Answers: <span id="correct-answers"></span></p>
                    <p>Score: <span id="score"></span>%</p>
                    <p>Time Taken: <span id="time-taken"></span></p>
                </div>
            </div>
            <div id="detailed-results">
                <!-- Detailed results will be inserted here -->
            </div>
            <div class="d-flex gap-2 mt-3">
                <button id="retry-quiz" class="btn btn-success">Retry This Quiz</button>
                <button id="download-results" class="btn btn-info">Download Results</button>
                <button id="restart" class="btn btn-primary">Go Back to Homepage</button>
            </div>
        </div>
    </div>

    <script>
        // Add jsPDF to window
        window.jsPDF = window.jspdf.jsPDF;
        
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let startTime;
        let timerInterval;
        let generatedQuestions = null;
        let lastQuestions = null;
        let lastResults = null;  // Store the last results for PDF generation

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function updateTimer() {
            const currentTime = new Date();
            const elapsedSeconds = Math.floor((currentTime - startTime) / 1000);
            document.getElementById('time-display').textContent = formatTime(elapsedSeconds);
        }

        function startTest(questions) {
            currentQuestions = questions;
            currentQuestionIndex = 0;
            userAnswers = {};
            
            // Setup timer
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
            
            // Setup question navigation
            const nav = document.querySelector('.question-nav');
            nav.innerHTML = '';
            questions.forEach((_, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-secondary';
                btn.textContent = index + 1;
                btn.onclick = () => showQuestion(index);
                nav.appendChild(btn);
            });
            
            document.getElementById('generator-section').classList.add('hidden');
            document.getElementById('test-section').classList.remove('hidden');

            // Get any existing answers from server
            fetch('/get-answers', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data.answers) {
                    userAnswers = data.answers;
                    // Update navigation buttons for existing answers
                    Object.keys(userAnswers).forEach(index => {
                        const navButtons = document.querySelectorAll('.question-nav button');
                        navButtons[index].classList.add('nav-answered');
                    });
                }
                showQuestion(0);
            })
            .catch(error => {
                console.error('Error getting answers:', error);
                showQuestion(0);
            });
        }

        function showQuestion(index) {
            currentQuestionIndex = index;
            const question = currentQuestions[index];
            
            document.getElementById('question-text').textContent = `Question ${index + 1}: ${question.question}`;
            
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            Object.entries(question.options).forEach(([key, value]) => {
                const button = document.createElement('button');
                const isAnswered = userAnswers.hasOwnProperty(index) && userAnswers[index] === key;
                button.className = `list-group-item list-group-item-action ${isAnswered ? 'active' : ''}`;
                button.textContent = `${key}) ${value}`;
                button.onclick = () => selectAnswer(key);
                optionsDiv.appendChild(button);
            });
            
            updateNavigationButtons();
        }

        function selectAnswer(answer) {
            userAnswers[currentQuestionIndex] = answer;
            
            // Update navigation button style
            const navButtons = document.querySelectorAll('.question-nav button');
            navButtons[currentQuestionIndex].classList.add('nav-answered');
            
            // Update option buttons
            const options = document.querySelectorAll('#options button');
            options.forEach(button => {
                button.classList.remove('active');
                if (button.textContent.startsWith(answer + ')')) {
                    button.classList.add('active');
                }
            });

            // Submit answer to server
            fetch('/submit-answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    questionIndex: currentQuestionIndex,
                    answer: answer
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Failed to save answer:', data.error);
                }
            })
            .catch(error => {
                console.error('Error submitting answer:', error);
            });
        }

        function updateNavigationButtons() {
            document.getElementById('prev-question').disabled = currentQuestionIndex === 0;
            document.getElementById('next-question').disabled = currentQuestionIndex === currentQuestions.length - 1;
        }

        function downloadResults() {
            if (!lastResults) return;

            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            
            // Title
            doc.setFontSize(20);
            doc.text('MCQ Test Results', pageWidth/2, 20, { align: 'center' });
            
            // Summary
            doc.setFontSize(14);
            doc.text('Summary', 20, 40);
            
            doc.setFontSize(12);
            const summary = [
                `Total Questions: ${lastResults.total_questions}`,
                `Difficulty Level: ${lastResults.difficulty ? lastResults.difficulty.charAt(0).toUpperCase() + lastResults.difficulty.slice(1).replace('_', ' ') : 'Not specified'}`,
                `Correct Answers: ${lastResults.correct_answers}`,
                `Score: ${((lastResults.correct_answers / lastResults.total_questions) * 100).toFixed(1)}%`,
                `Time Taken: ${formatTime(Math.floor(lastResults.duration))}`
            ];
            
            let yPos = 50;
            summary.forEach(line => {
                doc.text(line, 25, yPos);
                yPos += 8;
            });
            
            // Detailed Results
            doc.setFontSize(14);
            doc.text('Detailed Results', 20, yPos + 10);
            
            const detailedResults = lastResults.questions.map((q, index) => {
                return {
                    'Q.No': index + 1,
                    'Question': q.question,
                    'Your Answer': q.user_answer ? `${q.user_answer}) ${q.options[q.user_answer]}` : 'Not answered',
                    'Correct Answer': `${q.correct_answer}) ${q.options[q.correct_answer]}`,
                    'Status': q.is_correct ? 'Correct' : 'Incorrect'
                };
            });
            
            doc.autoTable({
                startY: yPos + 15,
                head: [['Q.No', 'Question', 'Your Answer', 'Correct Answer', 'Status']],
                body: detailedResults.map(r => [r['Q.No'], r.Question, r['Your Answer'], r['Correct Answer'], r.Status]),
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185], textColor: 255 },
                columnStyles: {
                    0: { cellWidth: 15 },
                    4: { cellWidth: 25 }
                },
                styles: {
                    overflow: 'linebreak',
                    cellPadding: 2
                }
            });
            
            // Save the PDF
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            doc.save(`mcq-results-${timestamp}.pdf`);
        }

        function showResults(results) {
            clearInterval(timerInterval);
            lastQuestions = generatedQuestions;  // Store questions for retry
            lastResults = results;  // Store results for PDF generation
            
            document.getElementById('test-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            // Update summary
            document.getElementById('total-questions').textContent = results.total_questions;
            document.getElementById('difficulty-level').textContent = results.difficulty || 'Not specified';
            document.getElementById('correct-answers').textContent = results.correct_answers;
            document.getElementById('score').textContent = ((results.correct_answers / results.total_questions) * 100).toFixed(1);
            document.getElementById('time-taken').textContent = formatTime(Math.floor(results.duration));
            
            // Show detailed results
            const detailedResults = document.getElementById('detailed-results');
            detailedResults.innerHTML = '';
            
            results.questions.forEach((q, index) => {
                const div = document.createElement('div');
                div.className = `card mb-3 ${q.is_correct ? 'result-correct' : 'result-incorrect'}`;
                div.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">Question ${index + 1}</h5>
                        <p>${q.question}</p>
                        <p>Your Answer: ${q.user_answer ? q.user_answer + ') ' + q.options[q.user_answer] : 'Not answered'}</p>
                        <p>Correct Answer: ${q.correct_answer}) ${q.options[q.correct_answer]}</p>
                    </div>
                `;
                detailedResults.appendChild(div);
            });
        }

        // Event Listeners
        document.querySelectorAll('input[name="input_method"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const urlSection = document.getElementById('url-section');
                const fileSection = document.getElementById('file-section');
                const urlInput = document.getElementById('url');
                const fileInput = document.getElementById('file');

                if (e.target.value === 'url') {
                    urlSection.classList.remove('hidden');
                    fileSection.classList.add('hidden');
                    urlInput.required = true;
                    fileInput.required = false;
                } else {
                    urlSection.classList.add('hidden');
                    fileSection.classList.remove('hidden');
                    urlInput.required = false;
                    fileInput.required = true;
                }
            });
        });

        document.getElementById('url-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const inputMethod = form.querySelector('input[name="input_method"]:checked').value;
            const numQuestions = form.num_questions.value;
            const difficulty = form.difficulty.value;
            
            document.getElementById('progress').classList.remove('hidden');
            
            try {
                const formData = new FormData();
                formData.append('num_questions', numQuestions);
                formData.append('difficulty', difficulty);
                
                if (inputMethod === 'url') {
                    formData.append('url', form.url.value);
                    formData.append('input_method', 'url');
                } else {
                    const file = form.file.files[0];
                    if (!file) {
                        throw new Error('Please select a file');
                    }
                    formData.append('file', file);
                    formData.append('input_method', 'file');
                }
                
                const response = await fetch('/generate', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Setup EventSource for progress updates
                const eventSource = new EventSource(`/progress/${data.queue_id}`);
                
                eventSource.onmessage = async (event) => {
                    const progress = JSON.parse(event.data);
                    
                    if (progress.progress) {
                        document.querySelector('.progress-bar').style.width = `${progress.progress}%`;
                    }
                    if (progress.status) {
                        document.getElementById('status').textContent = progress.status;
                    }
                    if (progress.complete) {
                        eventSource.close();
                        generatedQuestions = progress.questions;
                        showPreview(progress.questions.length);
                    }
                    if (progress.error) {
                        eventSource.close();
                        throw new Error(progress.error);
                    }
                };
            } catch (error) {
                document.getElementById('status').className = 'alert alert-danger';
                document.getElementById('status').textContent = error.message;
            }
        });

        function showPreview(totalQuestions) {
            // Hide generator section and show preview
            document.getElementById('generator-section').classList.add('hidden');
            document.getElementById('preview-section').classList.remove('hidden');
            
            // Update preview information
            const questions = generatedQuestions.questions || generatedQuestions;
            const numQuestions = questions.length;
            
            document.getElementById('preview-total-questions').textContent = numQuestions;
            document.getElementById('preview-difficulty').textContent = 
                (generatedQuestions.difficulty || document.getElementById('difficulty').value)
                .charAt(0).toUpperCase() + 
                (generatedQuestions.difficulty || document.getElementById('difficulty').value)
                .slice(1).replace('_', ' ');
            
            // Calculate estimated time (1.5 minutes per question)
            const estimatedMinutes = Math.ceil(numQuestions * 1.5);
            document.getElementById('preview-estimated-time').textContent = estimatedMinutes;
        }

        document.getElementById('start-test-btn').addEventListener('click', async () => {
            try {
                const startResponse = await fetch('/start-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questions: generatedQuestions.questions || generatedQuestions,
                        difficulty: document.getElementById('difficulty').value
                    })
                });
                
                if (!startResponse.ok) {
                    const errorData = await startResponse.json();
                    throw new Error(errorData.error || 'Failed to start test');
                }
                
                const testData = await startResponse.json();
                document.getElementById('preview-section').classList.add('hidden');
                startTest(testData.questions);
            } catch (error) {
                alert('Error starting test: ' + error.message);
            }
        });

        document.getElementById('regenerate-btn').addEventListener('click', () => {
            window.location.reload();
        });

        document.getElementById('restart').addEventListener('click', () => {
            window.location.reload();
        });

        document.getElementById('prev-question').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            }
        });

        document.getElementById('next-question').addEventListener('click', () => {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            }
        });

        document.getElementById('finish-test').addEventListener('click', async () => {
            if (Object.keys(userAnswers).length === 0) {
                alert('Please answer at least one question before finishing the test.');
                return;
            }
            
            if (confirm('Are you sure you want to finish the test?')) {
                try {
                    const response = await fetch('/finish-test', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ answers: userAnswers })
                    });
                    const results = await response.json();
                    showResults(results);
                } catch (error) {
                    alert('Error submitting test: ' + error.message);
                }
            }
        });

        // Add event listener for retry button
        document.getElementById('retry-quiz').addEventListener('click', () => {
            if (lastQuestions) {
                generatedQuestions = lastQuestions;  // Set the generated questions to last questions
                document.getElementById('results-section').classList.add('hidden');
                showPreview(lastQuestions.length);  // Show preview section with the same questions
            }
        });

        // Add event listener for download results button
        document.getElementById('download-results').addEventListener('click', downloadResults);
    </script>
</body>
</html> 