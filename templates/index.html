<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCQ Generator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíô</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        .hidden { display: none; }
        
        /* Mobile-first base styles */
        body {
            font-size: 16px;
            line-height: 1.6;
            padding-bottom: 60px; /* Space for footer */
        }

        .container {
            padding: 15px;
            max-width: 100%;
        }

        /* Title styles */
        .title-text {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            margin-bottom: 1.5rem;
            text-align: center;
            white-space: pre-line;
            line-height: 1.5;
        }
        
        .title-main {
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .title-sub {
            display: block;
            font-size: 0.9em;
        }

        @media (max-width: 576px) {
            .title-text {
                font-size: 1.3rem;
            }
            .title-text .subtitle {
                font-size: 1rem;
            }
        }

        /* Timer styles */
        #timer {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 0.9rem;
        }

        /* Question navigation */
        .question-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 15px 0;
            justify-content: center;
        }

        .question-nav button {
            width: 35px;
            height: 35px;
            padding: 0;
            font-size: 0.9rem;
        }

        .question-nav button.nav-answered {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .question-nav button.current {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Options styling */
        #options button {
            text-align: left;
            padding: 10px 15px;
            margin-bottom: 5px;
            white-space: normal;
            word-wrap: break-word;
        }

        /* Results section */
        .card {
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .card-body {
            padding: 15px;
        }

        /* Navigation buttons */
        .btn {
            padding: 8px 16px;
            font-size: 0.95rem;
            margin: 5px;
        }

        /* Footer */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.9rem;
            color: #6c757d;
            padding: 10px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            z-index: 1000;
        }

        .heart {
            color: #007bff;
            display: inline-block;
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Form elements */
        .form-control, .form-select {
            margin-bottom: 10px;
        }

        /* Results styling */
        .result-correct {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .result-incorrect {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        /* Responsive adjustments */
        @media (max-width: 576px) {
            h1 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }

            h2 {
                font-size: 1.3rem;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .d-flex {
                flex-direction: column;
            }

            #timer {
                position: static;
                margin-bottom: 15px;
                text-align: center;
            }

            .container {
                padding: 10px;
            }

            .card {
                margin: 10px 0;
            }
        }

        @media (min-width: 577px) and (max-width: 768px) {
            .container {
                max-width: 540px;
            }
        }

        @media (min-width: 769px) {
            .container {
                max-width: 720px;
            }

            .btn {
                margin: 5px;
            }
        }

        /* Improve touch targets on mobile */
        @media (hover: none) {
            .btn, 
            .form-control,
            .form-select,
            #options button {
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <!-- Generator Section -->
        <div id="generator-section">
            <h1 class="mb-4 text-center">
                MCQ Generator<br>
                (ùòîùòäùòò ùòéùòåùòï ùòàùòê)
            </h1>
            <form id="url-form" class="mb-4">
                <div class="mb-3">
                    <label class="form-label">Choose Input Method:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="input_method" id="url_input" value="url" checked>
                        <label class="form-check-label" for="url_input">URL</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="input_method" id="file_input" value="file">
                        <label class="form-check-label" for="file_input">File Upload</label>
                    </div>
                </div>
                
                <div id="url-section" class="mb-3">
                    <label for="url" class="form-label">Enter URL:</label>
                    <input type="url" class="form-control" id="url" name="url">
                </div>

                <div id="file-section" class="mb-3 hidden">
                    <label for="file" class="form-label">Upload File (PDF/Word/Text):</label>
                    <input type="file" class="form-control" id="file" name="file" accept=".pdf,.doc,.docx,.txt">
                    <small class="text-muted">Supported formats: PDF, Word (doc/docx), Text files</small>
                </div>

                <div class="mb-3">
                    <label for="num_questions" class="form-label">Number of Questions:</label>
                    <input type="number" class="form-control" id="num_questions" name="num_questions" value="{{ default_questions }}" min="5" max="100">
                </div>

                <div class="mb-3">
                    <label for="difficulty" class="form-label">Difficulty Level:</label>
                    <select class="form-select" id="difficulty" name="difficulty" required>
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                        <option value="very_hard">Very Hard</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">Generate Questions</button>
            </form>
            <div id="progress" class="hidden">
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="status" class="alert alert-info"></div>
            </div>
            <div class="footer">
                Made with <span class="heart">üíô</span> by V for U
            </div>
        </div>

        <!-- Preview Section -->
        <div id="preview-section" class="hidden">
            <h2 class="mb-4">Questions Generated Successfully!</h2>
            <div class="card mb-4">
                <div class="card-body">
                    <h5>Test Information</h5>
                    <p>Total Questions: <span id="preview-total-questions"></span></p>
                    <p>Difficulty Level: <span id="preview-difficulty"></span></p>
                    <p>Estimated Time: <span id="preview-estimated-time"></span> minutes</p>
                    <div class="alert alert-info">
                        <strong>Instructions:</strong>
                        <ul class="mb-0">
                            <li>Each question has 6 options (a-f)</li>
                            <li>You can navigate between questions</li>
                            <li>Timer will start when you begin the test</li>
                            <li>You can submit the test at any time</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button id="start-test-btn" class="btn btn-success">Start Test</button>
                <button id="regenerate-btn" class="btn btn-secondary">Generate New Questions</button>
            </div>
        </div>

        <!-- Test Section -->
        <div id="test-section" class="hidden">
            <div id="timer" class="mb-3">
                <div>Time: <span id="time-display">00:00</span></div>
                <div>Questions attempted: <span id="questions-attempted">0/0</span></div>
            </div>
            <div class="question-nav mb-4"></div>
            <div id="question-display" class="mb-4">
                <h3 id="question-text"></h3>
                <div id="options" class="list-group">
                    <!-- Options will be inserted here -->
                </div>
            </div>
            <div class="d-flex justify-content-between">
                <button id="prev-question" class="btn btn-secondary">Previous</button>
                <button id="next-question" class="btn btn-primary">Next</button>
                <button id="finish-test" class="btn btn-success">Finish Test</button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <h2 class="mb-4">Test Results</h2>
            <div class="card mb-4">
                <div class="card-body">
                    <h5>Summary</h5>
                    <p>Total Questions: <span id="total-questions"></span></p>
                    <p>Difficulty Level: <span id="difficulty-level"></span></p>
                    <p>Correct Answers: <span id="correct-answers"></span></p>
                    <p>Score: <span id="score"></span>%</p>
                    <p>Time Taken: <span id="time-taken"></span></p>
                </div>
            </div>
            <div id="detailed-results">
                <!-- Detailed results will be inserted here -->
            </div>
            <div class="d-flex gap-2 mt-3">
                <button id="retry-quiz" class="btn btn-success">Retry This Quiz</button>
                <button id="download-results" class="btn btn-info">Download Results</button>
                <button id="restart" class="btn btn-primary">Go Back to Homepage</button>
            </div>
            <div class="footer">
                Made with <span class="heart">üíô</span> by V for U
            </div>
        </div>
    </div>

    <script>
        // Add jsPDF to window
        window.jsPDF = window.jspdf.jsPDF;
        
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let startTime;
        let timerInterval;
        let generatedQuestions = null;
        let lastQuestions = null;
        let lastResults = null;  // Store the last results for PDF generation
        const questionsPerPage = 10; // Add pagination constant
        let currentPage = 0; // Add current page tracker

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function updateTimer() {
            const currentTime = new Date();
            const elapsedSeconds = Math.floor((currentTime - startTime) / 1000);
            document.getElementById('time-display').textContent = formatTime(elapsedSeconds);
        }

        function startTest(questions) {
            currentQuestions = questions;
            currentQuestionIndex = 0;
            currentPage = 0;
            userAnswers = {};  // Reset answers at start
            currentDifficulty = document.getElementById('difficulty').value;
            
            // Setup timer
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
            
            // Initialize questions attempted counter
            document.getElementById('questions-attempted').textContent = `0/${questions.length}`;
            
            // Setup question navigation
            const nav = document.querySelector('.question-nav');
            nav.innerHTML = '';
            
            // Only show buttons for current page
            const startIdx = currentPage * questionsPerPage;
            const endIdx = Math.min(startIdx + questionsPerPage, questions.length);
            
            for (let i = startIdx; i < endIdx; i++) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-secondary';
                btn.textContent = i + 1;
                btn.onclick = () => showQuestion(i);
                nav.appendChild(btn);
            }
            
            // Add page navigation
            const pageNav = document.createElement('div');
            pageNav.className = 'd-flex justify-content-center mt-2 gap-2';
            pageNav.style.width = '100%';
            pageNav.style.clear = 'both';
            
            const prevPageBtn = document.createElement('button');
            prevPageBtn.className = 'btn btn-outline-secondary';
            prevPageBtn.textContent = '‚Üê';
            prevPageBtn.style.width = '35px';
            prevPageBtn.style.height = '35px';
            prevPageBtn.style.padding = '0';
            prevPageBtn.style.fontSize = '0.9rem';
            prevPageBtn.onclick = () => changePage(currentPage - 1);
            prevPageBtn.disabled = currentPage === 0;
            
            const nextPageBtn = document.createElement('button');
            nextPageBtn.className = 'btn btn-outline-secondary';
            nextPageBtn.textContent = '‚Üí';
            nextPageBtn.style.width = '35px';
            nextPageBtn.style.height = '35px';
            nextPageBtn.style.padding = '0';
            nextPageBtn.style.fontSize = '0.9rem';
            nextPageBtn.onclick = () => changePage(currentPage + 1);
            nextPageBtn.disabled = (currentPage + 1) * questionsPerPage >= questions.length;
            
            const pageInfo = document.createElement('span');
            pageInfo.className = 'btn btn-light';
            pageInfo.textContent = `Page ${currentPage + 1}/${Math.ceil(questions.length/questionsPerPage)}`;
            
            pageNav.appendChild(prevPageBtn);
            pageNav.appendChild(pageInfo);
            pageNav.appendChild(nextPageBtn);
            nav.appendChild(pageNav);
            
            document.getElementById('generator-section').classList.add('hidden');
            document.getElementById('test-section').classList.remove('hidden');

            // Show first question immediately
            showQuestion(startIdx);
        }

        function changePage(newPage) {
            if (newPage < 0 || newPage >= Math.ceil(currentQuestions.length / questionsPerPage)) {
                return;
            }
            
            currentPage = newPage;
            const startIdx = currentPage * questionsPerPage;
            
            // Setup question navigation
            const nav = document.querySelector('.question-nav');
            nav.innerHTML = '';
            
            // Only show buttons for current page
            const endIdx = Math.min(startIdx + questionsPerPage, currentQuestions.length);
            
            // Update questions attempted counter
            document.getElementById('questions-attempted').textContent = `${Object.keys(userAnswers).length}/${currentQuestions.length}`;
            
            for (let i = startIdx; i < endIdx; i++) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-secondary';
                btn.textContent = i + 1;
                btn.onclick = () => showQuestion(i);
                if (userAnswers.hasOwnProperty(i)) {
                    btn.classList.add('nav-answered');
                }
                nav.appendChild(btn);
            }
            
            // Add page navigation
            const pageNav = document.createElement('div');
            pageNav.className = 'd-flex justify-content-center mt-2 gap-2';
            pageNav.style.width = '100%';  // Make it full width
            pageNav.style.clear = 'both';  // Force it to appear below floating elements
            
            const prevPageBtn = document.createElement('button');
            prevPageBtn.className = 'btn btn-outline-secondary';
            prevPageBtn.textContent = '‚Üê';
            prevPageBtn.style.width = '35px';
            prevPageBtn.style.height = '35px';
            prevPageBtn.style.padding = '0';
            prevPageBtn.style.fontSize = '0.9rem';
            prevPageBtn.onclick = () => changePage(currentPage - 1);
            prevPageBtn.disabled = currentPage === 0;
            
            const nextPageBtn = document.createElement('button');
            nextPageBtn.className = 'btn btn-outline-secondary';
            nextPageBtn.textContent = '‚Üí';
            nextPageBtn.style.width = '35px';
            nextPageBtn.style.height = '35px';
            nextPageBtn.style.padding = '0';
            nextPageBtn.style.fontSize = '0.9rem';
            nextPageBtn.onclick = () => changePage(currentPage + 1);
            nextPageBtn.disabled = (currentPage + 1) * questionsPerPage >= currentQuestions.length;
            
            const pageInfo = document.createElement('span');
            pageInfo.className = 'btn btn-light';
            pageInfo.textContent = `Page ${currentPage + 1}/${Math.ceil(currentQuestions.length/questionsPerPage)}`;
            
            pageNav.appendChild(prevPageBtn);
            pageNav.appendChild(pageInfo);
            pageNav.appendChild(nextPageBtn);
            nav.appendChild(pageNav);
            
            // Show first question of new page
            showQuestion(startIdx);
        }

        function showQuestion(index) {
            if (index < 0 || index >= currentQuestions.length) {
                return;
            }
            
            // Update page if necessary
            const targetPage = Math.floor(index / questionsPerPage);
            if (targetPage !== currentPage) {
                changePage(targetPage);
                return;
            }
            
            currentQuestionIndex = index;
            const question = currentQuestions[index];
            
            document.getElementById('question-text').textContent = `Question ${index + 1}: ${question.question}`;
            
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            Object.entries(question.options).forEach(([key, value]) => {
                const button = document.createElement('button');
                const isAnswered = userAnswers.hasOwnProperty(index) && userAnswers[index] === key;
                button.className = `list-group-item list-group-item-action ${isAnswered ? 'active' : ''}`;
                button.textContent = `${key}) ${value}`;
                button.onclick = () => selectAnswer(key);
                optionsDiv.appendChild(button);
            });
            
            // Update navigation buttons highlighting
            const navButtons = document.querySelectorAll('.question-nav button:not(.btn-secondary):not(.btn-light)');
            navButtons.forEach((btn, i) => {
                const questionIndex = currentPage * questionsPerPage + i;
                btn.classList.remove('current');
                if (userAnswers.hasOwnProperty(questionIndex)) {
                    btn.classList.add('nav-answered');
                }
            });
            const currentBtn = navButtons[index % questionsPerPage];
            if (currentBtn) {
                currentBtn.classList.add('current');
            }
            
            updateNavigationButtons();
        }

        function selectAnswer(answer) {
            userAnswers[currentQuestionIndex] = answer;
            
            // Update questions attempted counter
            document.getElementById('questions-attempted').textContent = `${Object.keys(userAnswers).length}/${currentQuestions.length}`;
            
            // Update navigation button style
            const navButtons = document.querySelectorAll('.question-nav button:not(.btn-secondary):not(.btn-light)');
            const buttonIndex = currentQuestionIndex % questionsPerPage;
            if (navButtons[buttonIndex]) {
                navButtons[buttonIndex].classList.add('nav-answered');
            }
            
            // Update option buttons
            const options = document.querySelectorAll('#options button');
            options.forEach(button => {
                button.classList.remove('active');
                if (button.textContent.startsWith(answer + ')')) {
                    button.classList.add('active');
                }
            });

            // Save to localStorage as backup
            localStorage.setItem('mcq_answers', JSON.stringify(userAnswers));
        }

        function updateNavigationButtons() {
            document.getElementById('prev-question').disabled = currentQuestionIndex === 0;
            document.getElementById('next-question').disabled = currentQuestionIndex === currentQuestions.length - 1;
        }

        function downloadResults() {
            if (!lastResults) return;

            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            
            // Title
            doc.setFontSize(20);
            doc.text('MCQ Test Results', pageWidth/2, 20, { align: 'center' });
            
            // Summary
            doc.setFontSize(14);
            doc.text('Summary', 20, 40);
            
            doc.setFontSize(12);
            const summary = [
                `Total Questions: ${lastResults.total_questions}`,
                `Difficulty Level: ${lastResults.difficulty ? lastResults.difficulty.charAt(0).toUpperCase() + lastResults.difficulty.slice(1).replace('_', ' ') : 'Not specified'}`,
                `Correct Answers: ${lastResults.correct_answers}`,
                `Score: ${((lastResults.correct_answers / lastResults.total_questions) * 100).toFixed(1)}%`,
                `Time Taken: ${formatTime(Math.floor(lastResults.duration))}`
            ];
            
            let yPos = 50;
            summary.forEach(line => {
                doc.text(line, 25, yPos);
                yPos += 8;
            });
            
            // Detailed Results
            doc.setFontSize(14);
            doc.text('Detailed Results', 20, yPos + 10);
            
            const detailedResults = lastResults.questions.map((q, index) => {
                return {
                    'Q.No': index + 1,
                    'Question': q.question,
                    'Your Answer': q.user_answer ? `${q.user_answer}) ${q.options[q.user_answer]}` : 'Not answered',
                    'Correct Answer': `${q.correct_answer}) ${q.options[q.correct_answer]}`,
                    'Status': q.is_correct ? 'Correct' : 'Incorrect'
                };
            });
            
            doc.autoTable({
                startY: yPos + 15,
                head: [['Q.No', 'Question', 'Your Answer', 'Correct Answer', 'Status']],
                body: detailedResults.map(r => [r['Q.No'], r.Question, r['Your Answer'], r['Correct Answer'], r.Status]),
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185], textColor: 255 },
                columnStyles: {
                    0: { cellWidth: 15 },
                    4: { cellWidth: 25 }
                },
                styles: {
                    overflow: 'linebreak',
                    cellPadding: 2
                }
            });
            
            // Save the PDF
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            doc.save(`mcq-results-${timestamp}.pdf`);
        }

        function showResults(results) {
            clearInterval(timerInterval);
            lastQuestions = generatedQuestions;  // Store questions for retry
            lastResults = results;  // Store results for PDF generation
            
            document.getElementById('test-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            // Update summary
            document.getElementById('total-questions').textContent = results.total_questions;
            document.getElementById('difficulty-level').textContent = results.difficulty || 'Not specified';
            document.getElementById('correct-answers').textContent = results.correct_answers;
            document.getElementById('score').textContent = ((results.correct_answers / results.total_questions) * 100).toFixed(1);
            document.getElementById('time-taken').textContent = formatTime(Math.floor(results.duration));
            
            // Show detailed results
            const detailedResults = document.getElementById('detailed-results');
            detailedResults.innerHTML = '';
            
            results.questions.forEach((q, index) => {
                const div = document.createElement('div');
                div.className = `card mb-3 ${q.is_correct ? 'result-correct' : 'result-incorrect'}`;
                div.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">Question ${index + 1}</h5>
                        <p>${q.question}</p>
                        <p>Your Answer: ${q.user_answer ? q.user_answer + ') ' + q.options[q.user_answer] : 'Not answered'}</p>
                        <p>Correct Answer: ${q.correct_answer}) ${q.options[q.correct_answer]}</p>
                    </div>
                `;
                detailedResults.appendChild(div);
            });
        }

        // Event Listeners
        document.querySelectorAll('input[name="input_method"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const urlSection = document.getElementById('url-section');
                const fileSection = document.getElementById('file-section');
                const urlInput = document.getElementById('url');
                const fileInput = document.getElementById('file');

                if (e.target.value === 'url') {
                    urlSection.classList.remove('hidden');
                    fileSection.classList.add('hidden');
                    urlInput.required = true;
                    fileInput.required = false;
                } else {
                    urlSection.classList.add('hidden');
                    fileSection.classList.remove('hidden');
                    urlInput.required = false;
                    fileInput.required = true;
                }
            });
        });

        document.getElementById('url-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Prompt for master password
            const masterPassword = prompt('Please enter the master password:');
            if (!masterPassword) {
                return;  // User cancelled the prompt
            }
            
            const form = e.target;
            const inputMethod = form.querySelector('input[name="input_method"]:checked').value;
            const numQuestions = form.num_questions.value;
            const difficulty = form.difficulty.value;
            
            document.getElementById('progress').classList.remove('hidden');
            
            try {
                const formData = new FormData();
                formData.append('num_questions', numQuestions);
                formData.append('difficulty', difficulty);
                formData.append('master_password', masterPassword);
                
                if (inputMethod === 'url') {
                    formData.append('url', form.url.value);
                    formData.append('input_method', 'url');
                } else {
                    const file = form.file.files[0];
                    if (!file) {
                        throw new Error('Please select a file');
                    }
                    formData.append('file', file);
                    formData.append('input_method', 'file');
                }
                
                const response = await fetch('/generate', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.status === 403) {
                    throw new Error('Invalid master password');
                }
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Setup EventSource for progress updates
                const eventSource = new EventSource(`/progress/${data.queue_id}`);
                
                eventSource.onmessage = async (event) => {
                    const progress = JSON.parse(event.data);
                    
                    if (progress.progress) {
                        document.querySelector('.progress-bar').style.width = `${progress.progress}%`;
                    }
                    if (progress.status) {
                        document.getElementById('status').textContent = progress.status;
                    }
                    if (progress.complete) {
                        eventSource.close();
                        generatedQuestions = progress.questions;
                        showPreview(progress.questions.length);
                    }
                    if (progress.error) {
                        eventSource.close();
                        throw new Error(progress.error);
                    }
                };
            } catch (error) {
                document.getElementById('status').className = 'alert alert-danger';
                document.getElementById('status').textContent = error.message;
            }
        });

        function showPreview(totalQuestions) {
            // Hide generator section and show preview
            document.getElementById('generator-section').classList.add('hidden');
            document.getElementById('preview-section').classList.remove('hidden');
            
            // Update preview information
            const questions = generatedQuestions.questions || generatedQuestions;
            const numQuestions = questions.length;
            
            document.getElementById('preview-total-questions').textContent = numQuestions;
            document.getElementById('preview-difficulty').textContent = 
                (generatedQuestions.difficulty || document.getElementById('difficulty').value)
                .charAt(0).toUpperCase() + 
                (generatedQuestions.difficulty || document.getElementById('difficulty').value)
                .slice(1).replace('_', ' ');
            
            // Calculate estimated time (1.5 minutes per question)
            const estimatedMinutes = Math.ceil(numQuestions * 1.5);
            document.getElementById('preview-estimated-time').textContent = estimatedMinutes;
        }

        document.getElementById('start-test-btn').addEventListener('click', () => {
            try {
                // Start test directly with the generated questions
                const questions = generatedQuestions.questions || generatedQuestions;
                document.getElementById('preview-section').classList.add('hidden');
                startTest(questions);
            } catch (error) {
                alert('Error starting test: ' + error.message);
            }
        });

        document.getElementById('regenerate-btn').addEventListener('click', () => {
            window.location.reload();
        });

        document.getElementById('restart').addEventListener('click', () => {
            window.location.reload();
        });

        document.getElementById('prev-question').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            }
        });

        document.getElementById('next-question').addEventListener('click', () => {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            }
        });

        document.getElementById('finish-test').addEventListener('click', () => {
            if (Object.keys(userAnswers).length === 0) {
                alert('Please answer at least one question before finishing the test.');
                return;
            }
            
            if (confirm('Are you sure you want to finish the test?')) {
                try {
                    // Calculate results client-side
                    const results = checkAnswers(currentQuestions);
                    showResults(results);
                } catch (error) {
                    console.error('Error processing results:', error);
                    alert('Error processing results: ' + error.message);
                }
            }
        });

        // Add event listener for retry button
        document.getElementById('retry-quiz').addEventListener('click', async () => {
            if (lastQuestions) {
                // Reset all answers and session data
                userAnswers = {};
                try {
                    // Clear session answers on server
                    await fetch('/start-test', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            questions: lastQuestions,
                            difficulty: document.getElementById('difficulty').value,
                            reset: true
                        })
                    });
                    
                    generatedQuestions = lastQuestions;  // Set the generated questions to last questions
                    document.getElementById('results-section').classList.add('hidden');
                    showPreview(lastQuestions.length);  // Show preview section with the same questions
                } catch (error) {
                    console.error('Error resetting quiz:', error);
                    alert('Error resetting quiz. Please try again.');
                }
            }
        });

        // Add event listener for download results button
        document.getElementById('download-results').addEventListener('click', downloadResults);

        // Add these functions for client-side answer checking
        function checkAnswers(questions) {
            const results = {
                total_questions: questions.length,
                correct_answers: 0,
                questions: [],
                duration: calculateDuration(),
                difficulty: currentDifficulty
            };
            
            questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.correct_answer;
                
                if (isCorrect) {
                    results.correct_answers++;
                }
                
                results.questions.push({
                    question: question.question,
                    options: question.options,
                    user_answer: userAnswer,
                    correct_answer: question.correct_answer,
                    is_correct: isCorrect
                });
            });
            
            return results;
        }

        function calculateDuration() {
            return Math.floor((Date.now() - startTime) / 1000);
        }

        // Replace the existing submitTest function with this new version
        async function submitTest() {
            if (!currentQuestions || currentQuestions.length === 0) {
                showError('No test in progress');
                return;
            }

            const submitButton = document.getElementById('submit-test');
            submitButton.disabled = true;
            
            try {
                // Calculate results client-side
                const results = checkAnswers(currentQuestions);
                
                // Display results
                displayResults(results);
                
                // Clear test state
                userAnswers = {};
                localStorage.removeItem('mcq_answers');
                currentQuestions = null;
                startTime = null;
                
                // Hide test interface
                document.getElementById('test-interface').classList.add('hidden');
                document.getElementById('results-section').classList.remove('hidden');
                
                // Stop and hide timer
                clearInterval(timerInterval);
                document.getElementById('timer').classList.add('hidden');
                
            } catch (error) {
                showError('Error processing results: ' + error.message);
                submitButton.disabled = false;
            }
        }

        // Update the displayResults function to handle the new format
        function displayResults(results) {
            const resultsDiv = document.getElementById('results-section');
            const summaryDiv = document.getElementById('results-summary');
            const detailsDiv = document.getElementById('results-details');
            
            // Calculate percentage
            const percentage = ((results.correct_answers / results.total_questions) * 100).toFixed(2);
            
            // Format duration
            const duration = formatDuration(results.duration);
            
            // Update summary
            summaryDiv.innerHTML = `
                <h3 class="mb-4">Test Results</h3>
                <div class="alert alert-info">
                    <p><strong>Score:</strong> ${results.correct_answers}/${results.total_questions} (${percentage}%)</p>
                    <p><strong>Time Taken:</strong> ${duration}</p>
                    <p><strong>Difficulty:</strong> ${results.difficulty}</p>
                </div>
            `;
            
            // Update details
            detailsDiv.innerHTML = '<h4 class="mb-3">Detailed Review</h4>';
            results.questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = `card mb-3 ${q.is_correct ? 'border-success' : 'border-danger'}`;
                
                questionDiv.innerHTML = `
                    <div class="card-header ${q.is_correct ? 'bg-success text-white' : 'bg-danger text-white'}">
                        Question ${index + 1} - ${q.is_correct ? 'Correct' : 'Incorrect'}
                    </div>
                    <div class="card-body">
                        <p class="card-text"><strong>Q:</strong> ${q.question}</p>
                        <div class="options-review">
                            ${Object.entries(q.options).map(([key, value]) => `
                                <div class="option ${key === q.correct_answer ? 'text-success' : ''} ${key === q.user_answer && key !== q.correct_answer ? 'text-danger' : ''}">
                                    ${key}) ${value}
                                    ${key === q.correct_answer ? ' ‚úì' : ''}
                                    ${key === q.user_answer && key !== q.correct_answer ? ' ‚úó' : ''}
                                </div>
                            `).join('')}
                        </div>
                        ${!q.is_correct ? `
                            <div class="mt-2">
                                <strong>Your answer:</strong> ${q.user_answer || 'Not answered'}<br>
                                <strong>Correct answer:</strong> ${q.correct_answer}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                detailsDiv.appendChild(questionDiv);
            });
            
            // Show results section
            resultsDiv.classList.remove('hidden');
        }
    </script>
</body>
</html> 